# 毛发渲染

Author: 邓一帆
日期: April 8, 2022

## Marschner模型

        

### 毛发结构

         

        头发是一种介电材质，除了黑色头发以外，其他颜色的头发都具有良好的不透明特性。从微观上看，毛发表面有着一层层的鳞片结构，被称为角质层。这一层倒圆锥结构对光散射起到重要作用。内层是一层髓质，决定了着色。

![SG03-hair.jpg](%E6%AF%9B%E5%8F%91%E6%B8%B2%E6%9F%93%20b61a11035bac4e1c99f9e4041593ac34/SG03-hair.jpg)

       

![1617944-20190717102237553-838630971.jpg](%E6%AF%9B%E5%8F%91%E6%B8%B2%E6%9F%93%20b61a11035bac4e1c99f9e4041593ac34/1617944-20190717102237553-838630971.jpg)

                                                             图一：头发的微表面模型

![屏幕截图 2022-04-06 191931.png](%E6%AF%9B%E5%8F%91%E6%B8%B2%E6%9F%93%20b61a11035bac4e1c99f9e4041593ac34/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_2022-04-06_191931.png)

                                                    图二： 毛发模型示意图

          我们把毛发近似为一层层的圆锥嵌套结构。图二中标识出了光照在毛发中作用的3个部分。

- R：表面反射，产生主高光，由头发切线方向和纤维上的鳞片倾斜影响。
- TT：内部折射，遵循折射定律，浅色头发的强前向散射成分。这会使金色、棕色、灰色和白色头发在光线从后面发出时看起来非常明亮。
- TRT：光线进入毛发内部后从内部反射并折射出来，同样遵循折射定律，产生次高光。

![屏幕截图 2022-04-06 194057.png](%E6%AF%9B%E5%8F%91%E6%B8%B2%E6%9F%93%20b61a11035bac4e1c99f9e4041593ac34/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_2022-04-06_194057.png)

图三：入射面内的散射测量图，可以看出，R和TRT部分的反射锥体稍微偏离理想镜面锥体，并向两个相反方向偏离，使得视觉上形成了两个可以区分的高光。黑色头发的偏离度要明显低于浅色头发。

### 符号说明

这里列出了下面进行讨论时用到的一些符号释义

- $u$：头发的切线方向，由根部指向尖端。
- 向量 $v,w$构成右手正交基，如果横截面为椭圆， $v$为长轴， $w$为短轴。我们将 $v-w$平面成为法线平面。
- $\omega_{i}$：照明方向。
- $\omega_{r}$：散射光的计算或测量方向。
- $\omega_{i}$和 $\omega_{r}$都指向远离中心的方向，用球坐标表示。
- $\theta_{i}和\theta_{r}$：相对于法平面的倾斜平面，定义 $0^{\circ}$垂直于头发， $90^{\circ}$是 $u$， $-90^{\circ}$是 $-u$。
- $\phi_{i}和\phi_{r}$：头发周围的方位角，定义 $v$为 $0^{\circ}$， $w为+90^{\circ}$。
- $\theta_{d}$： $\left(\theta_{r}-\theta_{i}\right) / 2$
- $\phi$： $\left(\phi_{r}-\phi_{i}\right) / 2$
- $\theta_{h}$： $\left(\theta_{i}+\theta_{r}\right) / 2$
- $\phi_{h}$： $\left(\phi_{i}-\phi_{r}\right) / 2$

  首先回顾一下brdf:

$$
f(l, v)=\frac{d L_{o}(v)}{d E(l)}
$$

$$
L_{i}(l)=\frac{d \Phi}{d \omega_{i} d A^{\perp}}=\frac{d \Phi}{d \omega_{i} d A \cos \theta_{i}}=\frac{d E(l)}{d \omega_{i} \cos \theta_{i}}
$$

$$
d E(l)=L_{i}(l) d \omega_{i} \cos \theta_{i}
$$

$$
d L_{o}(v)=f(l, v) \otimes d E(l)=f(l, v) \otimes L_{i}(l) d \omega_{i} \cos \theta_{i}
$$

$$
L_{o}(v)=\int_{\Omega} f(l, v) \otimes L_{i}(l) \cos \theta_{i} d \omega_{i}
$$

其中 $L$为表面光强（intensity）， $E$为表面辐照度（irradiance）

那么对于头发的纤维表面散射函数，定义 $\bar{E}$为曲线辐照度， $\bar{L}$为曲线光强，则纤维双向散射函数（bsf）为：

$$
S\left(\omega_{i}, \omega_{r}\right)=\frac{d \bar{L}_{r}\left(\omega_{r}\right)}{d E_{i}\left(\omega_{i}\right)}
$$

式中 $\bar{L}_{r}$为无限小长度纤维散射的曲线光强， $\bar{E}_{i}$是该部分纤维上的曲线辐照度（irradiance），该辐照度与入射辐射（radiance）成正比：

$$
d \bar{E}_{i}\left(\omega_{i}\right)=D L_{i}\left(\omega_{i}\right) \cos \theta_{i} d \omega_{i}
$$

其中 $D$是纤维直径，据此可以定义散射积分为：

$$
\bar{L}_{r}\left(\omega_{r}\right)=D \int S\left(\omega_{i}, \omega_{r}\right) L_{i}\left(\omega_{i}\right) \cos \theta_{i} d \omega_{i}
$$

### 纤维散射理论

        在给出毛发渲染模型之前，我们先推导出光滑圆柱体散射模型，并将其作为近似值扩展到毛发渲染模型中。由于圆柱体的对称性，4D散射函数可以表示为两个2D散射函数的乘积。我们用 $M$项表示 $\theta$平面的函数， $N$项表示 $\phi$平面的函数。

1. 圆柱表面散射
    
    首先声明以下两个定理：
    
    - 以特定轴线倾角进入介质柱体的光线，无论其经历的折射和反射顺序如何，都将以相同的倾角离开。
        - 假设圆柱体内部没有体积散射。
    - 可以通过只检查垂直于平面投影的头发来分析散射分布对 $\phi_{r}$的依赖性。
        - 由于来自特定入射方向的所有光线都与法向平面保持相同的倾角，因此，在法向平面内对任意折射率进行二维分析就足以描述三维散射函数。原折射率表示为 $\eta$，则 $\eta^{\prime}$表示为投影矢量的折射率。 $\eta^{\prime}>\eta$
    
     任意截面光滑圆柱体表面散射函数可以写为：
    
    $$
    S\left(\phi_{i}, \theta_{i} ; \phi_{r}, \theta_{r}\right)=M\left(\theta_{i}, \theta_{r}\right) N\left(\eta^{\prime}\left(\theta_{d}\right) ; \phi_{i}, \phi_{r}\right) / \cos ^{2} \theta_{d}        (1)
    $$
    
2. 圆形截面散射：
    
    ![屏幕截图 2022-04-07 195004.png](%E6%AF%9B%E5%8F%91%E6%B8%B2%E6%9F%93%20b61a11035bac4e1c99f9e4041593ac34/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_2022-04-07_195004.png)
    

                                              图四：圆形截面散射的几何图形

假设 $N$为圆形横截面。对于圆对称， $N$仅取决于 $\phi$ $(\phi_{i}-\phi_{r})$，因此2D方位散射函数进一步简化为1D

如图四所示，考虑入射光线在一个单位圆 $-1<h<1$上的偏移，角度 $sin\gamma_{i}=h$是入射角， $\eta^{\prime}sin\gamma_{t}=h$为折射角，通过跟踪光线计算出出射角 $\phi(h)$。

从图四可以看出：

- 入射光线进入截面时偏离角度为 $\gamma_{t}-\gamma_{i}$。
- 内部反射的偏离角度为 $\pi+2\gamma_{t}$。
- 出射时的偏离角度为 $\gamma_{t}-\gamma_{i}$。

则：

$$
\phi(p, h)=2 p \gamma_{t}-2 \gamma_{i}+p \pi(2)
$$

对于不同的 $p$，有R $(p=0)$，TT $(p=1)$，TRT $(p=2)$，接下来的讨论中我们将忽略 $p>2$项。

上面的计算通过h来参数化路径，然而，对于散射的计算，我们通常需要找到在给定出射角 $\phi$上与散射相关的所有路径。 $h$值通常由求解函数 $\phi(p,h)-\phi=0$得到。显然，在 $p=0$或 $p=1$时方程只有一个根，在 $p=2$时，可能有 $1$个或 $3$个根。

由于函数 $\phi(p,h)$是连续的，对于方程 $\phi(p,h)-\phi=0$，根由一个变成三个发生在导数 $\frac{d \phi}{d h}=0$时，笛卡尔首先指出 $\frac{d \phi}{d h}=0$发生在：

$$
h^{2}=\left(4-\left(\eta^{\prime}\right)^{2}\right) / 3 (3)                       
$$

该表达式是对称的，并预测存在两个对称极值。[Humphreys 1964]

现在根据能量守恒原理可以计算散射光的强度，当曲线辐照度 $\bar{E}$照亮纤维时，平均辐照度 $\bar{E}/2$落在整个宽度的横截面上。在不考虑衰减的情况下，存在一个强度分布：

$$
\bar{L}(\phi(h)) d \phi=E(h) d h=(\bar{E} / 2) d h
$$

或

$$
\bar{L}(\phi(h))=\left|2 \frac{d \phi}{d h}\right|^{-1} \bar{E}
$$

这个方程意味着 $\frac{d \phi}{d h}=0$时光强无限大，这种强度奇点被称为焦散（caustic）

1. 吸收和反射衰减

对于吸收，用余弦定理计算图四的三角形，得到纤维内部的路径长度为 $2+2cos(2\gamma_{t})$，设置 $\sigma_{a}$为单位长度的体积吸收，单位长度定义为纤维半径，头发内每一个段数 $p$对吸收的影响贡献一个系数 $T\left(\sigma_{a}, h\right)=\exp \left(-2 \sigma_{a}\left(1+\cos \left(2 \gamma_{t}\right)\right)\right)$

现在我们可以在路径贡献的强度前面引入一个衰减因子：

$$
\bar{L}(\phi)=A(p, h)\left|2 \frac{d \phi}{d h}\right|^{-1} \bar{E}(4)
$$

其中：

$$
\begin{array}{l}A(0, h)=F\left(\eta, \gamma_{i}\right) \\A(p, h)=\left(1-F\left(\eta, \gamma_{i}\right)\right)^{2} F\left(1 / \eta, \gamma_{t}\right)^{p-1} T\left(\sigma_{a}, h\right)^{p}\end{array}
$$

通过改变参数可以将 $A$推广到斜入射，正确的系数可以通过两个虚拟折射率算出。在斜入射基础上，用 $\sigma_{a}^{\prime}(\theta)=\sigma_{a} / \cos \theta_{t}$代替 $\sigma_{a}$，则：

$$
\begin{array}{l}A(0, h)=F\left(\eta^{\prime}, \eta^{\prime \prime}, \gamma_{i}\right) \\A(p, h)=\left(1-F\left(\eta^{\prime}, \eta^{\prime \prime}, \gamma_{i}\right)\right)^{2} F\left(\frac{1}{\eta^{\prime}}, \frac{1}{\eta^{\prime \prime}}, \gamma_{t}\right)^{p-1} T\left(\sigma_{a}^{\prime}, h\right)^{p}\end{array}
$$

因此，完整的法向平面散射函数是：

$$
\begin{aligned}N(\phi) &=\sum_{p} N_{p}(p, \phi) \\N_{p}(p, \phi) &=\sum_{r} A(p, h(p, r, \phi))\left|2 \frac{d \phi}{d h}(p, h(p, r, \phi))\right|^{-1}\end{aligned}(5)
$$

其中的求和包括了多种 $(p)$的情况，包括具有多个根的路径。

1. 总结

我们假设定向光束入射并散射形成一个完美的圆锥体，圆锥体的光线分布是三种散射的总和，即：

$$
\begin{aligned}S\left(\phi_{i}, \theta_{i} ; \phi_{r},\right.&\left.\theta_{r}\right)=\\& M_{R}\left(\theta_{h}\right) N_{R}\left(\eta^{\prime}\left(\eta, \theta_{d}\right) ; \phi\right) / \cos ^{2} \theta_{d}+\\& M_{T T}\left(\theta_{h}\right) N_{T T}\left(\eta^{\prime}\left(\eta, \theta_{d}\right) ; \phi\right) / \cos ^{2} \theta_{d}+\\& M_{T R T}\left(\theta_{h}\right) N_{T R T}\left(\eta^{\prime}\left(\eta^{*}\left(\phi_{h}\right), \theta_{d}\right) ; \phi\right) / \cos ^{2} \theta_{d}\end{aligned}(6)
$$

这个方程源自方程（1），包含了三项独立的纵向近似函数 $M_{R},M_{TT},M_{TRT}$，用来模拟3项散射中角质层鳞片的影响。三项横向散射函数 $N_{R},N_{TT},N_{TRT}$，其中前两项为 $N_{p}(p,\phi)$,即：

$$
\begin{aligned}N_{R}(\phi) &=N_{p}(0, \phi) \\N_{T T}(\phi) &=N_{p}(1, \phi)\end{aligned}
$$

第三项将在后面给出详细讨论。

### 毛发着色模型

![屏幕截图 2022-04-08 154919.png](%E6%AF%9B%E5%8F%91%E6%B8%B2%E6%9F%93%20b61a11035bac4e1c99f9e4041593ac34/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_2022-04-08_154919.png)

                                                   表一：着色模型中用到的参数

1. 纵向散射函数 $M$

 在光滑圆柱体上，反射光将分布在一个镜面圆锥中。但在我们的毛发模型中，有两个因素会导致结果偏离这个圆锥。首先，毛发表面是粗糙的，漫反射将导致反射光向四面八方传播。其次，表层的鳞片导致法线倾斜，使反射光偏离。

图二显示了这种偏移导致的结果， $R$项向根部偏移 $2\alpha$， $TRT$项向尖端偏移大于 $2\alpha$角， $TT$项向尖端偏移小于 $2\alpha$角， $\alpha$的典型值在表一中给出。通过近似计算模拟这些偏移的影响，得到：

$$
\begin{aligned}M_{R}\left(\theta_{h}\right) &=g\left(\beta_{R} ; \theta_{h}-\alpha_{R}\right) \\M_{T T}\left(\theta_{h}\right) &=g\left(\beta_{T T} ; \theta_{h}-\alpha_{T T}\right) \\M_{T R T}\left(\theta_{h}\right) &=g\left(\beta_{T R T} ; \theta_{h}-\alpha_{T R T}\right)\end{aligned}(7)
$$

$g(\beta,x)$是一个单位积分函数，即积分为1的函数，在计算中可以采用以 $\beta$为标准差的单位正态分布函数， $\beta$由b。

 2.  横向散射函数 $N$

  介绍3种 $N$的近似方法，第一种是求解路径，第二种是次高光的现象模型，第三种是闪光的简单模型。

- 求解路径

为找到路径，需要对方程 $\phi(p,h)-\phi=0$求解，精确求解的计算量很大。

为了简化角度的依赖关系，我们用一个三次多项式来近似折射定律，在 $\pm 90^{\circ}$时该表达式的值和导数与原表达式相同：

$$
\gamma_{t}=\frac{3 c}{\pi} \gamma_{i}-\frac{4 c}{\pi^{3}} \gamma_{i}^{3}
$$

其中 $c=\sin ^{-1}\left(1 / \eta^{\prime}\right)$，最大近似误差不大于 $0.75^{\circ}(\eta>1.5时)$。

此时， $\phi$是 $\gamma_{i}$的一个三次函数：

$$
\hat{\phi}\left(p, \gamma_{i}\right)=\left(\frac{6 p c}{\pi}-2\right) \gamma_{i}-\frac{8 p c}{\pi^{3}} \gamma_{i}^{3}+p \pi
$$

将此近似值代入方程中可以很容易地求出 $h$。同样的，对于 $R$和 $TT$，方程有一个根，对于 $TRT$，方程有一个或三个根。

![屏幕截图 2022-04-08 165517.png](%E6%AF%9B%E5%8F%91%E6%B8%B2%E6%9F%93%20b61a11035bac4e1c99f9e4041593ac34/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_2022-04-08_165517.png)

图五：在与图三相同的几何条件下，使用着色模型近似得到的结果，参数被调整为匹配金色头发的数值。

- TRT近似

在基于光滑表面的圆柱的散射的理论计算中， $TRT$分量中的焦散线会在 $S$中产生光强无限大的奇点，这意味着次高光部分将产生不合常理的白色高光。我们的近似将从 $N_{TRT}$中去除焦散，并用一个平滑曲线代替，模拟表面粗糙导致的焦散模糊。

焦散出现的角度 $\phi_{c}$可以由 $h^{2}=\left(4-\left(\eta^{\prime}\right)^{2}\right) / 3$算出，我们在 $\phi_{c}=0$时插入焦散，要在一定的入射角度淡出焦散，可以用如下的方法：

$$
\begin{array}{l}\text { function } N_{T R T}\left(\theta, \phi ; w_{C}, k_{G}, \Delta \eta^{\prime}, \Delta h_{M}\right) \\\text { if }\left(\eta^{\prime}(\theta)<2\right) \\\quad \text { Compute } h_{c}, \phi_{c} \text { using } \eta^{\prime}(\theta) \text { in }(4) \\\quad \Delta h=\min \left(\Delta h_{M}, 2 \sqrt{\left.2 w_{c} /\left|\frac{d^{2} \phi}{d h^{2}}\left(h_{C}\right)\right|\right)}\right. \\\quad t=1 \\\text { else } \\\quad \phi_{c}=0 \\\quad \Delta h=\Delta h_{M} \\\quad t=\operatorname{smoothstep}\left(2,2+\Delta \eta^{\prime}, \eta^{\prime}(\theta)\right) \\L=N_{p}(2, \phi) \\L=L \cdot\left(1-\operatorname{tg}\left(\phi-\phi_{C}, w_{C}\right) / g\left(0, w_{C}\right)\right) \\L=L \cdot\left(1-\operatorname{tg}\left(\phi+\phi_{c}, w_{C}\right) / g\left(0, w_{C}\right)\right) \\L=L+t k_{G} A(2, \theta, \phi) \Delta h\left(g\left(\phi-\phi_{c}, w_{C}\right)+g\left(\phi+\phi_{C}, w_{C}\right)\right) \\\text { return } L\end{array}
$$

首先根据 $d^{2} \phi / d h^{2}$来估计 $\Delta h$， $\Delta h$为定义在 $w_{c}$内部的h的间隔长度， $w_{c}$为焦散模糊的宽度。 $d^{2} \phi / d h^{2}$在焦散合并时为0，故需要定义最小值 $\Delta h_{M}$。对于函数 $smoothstep(a,b,x)$， $x<a$时，返回 $0$， $x>b$时，返回 $1$， $a<x<b$时，返回 $0$到 $1$之间的线性插值。

- 偏心率近似

当横截面为椭圆而不是圆形时， $N$的简单解析将不可用。然而轻微的偏心率变化也会显著影响 $TRT$项的结果，当偏心率 $a$在 $a=0.85$到 $a=0.85/1$之间变化时，焦散线出现的角度 $\phi_{c}$的变化幅度会达到 $\pm 100\%$。由于该范围的偏心率在实际的毛发中十分常见，因此计算偏心率对 $TRT$项的影响十分重要。我们使用式（6）中的 $\eta^*$来计算。

改变折射率在性质上和改变偏心率有一样的效果，对沿长轴对称的傍轴路径的分析较为简单，对于这些路径， $\phi_{i}=\phi_{r}$，反射位置在轴上。设 $\gamma^{\prime}_{t}$为内反射的入射角，则：

$$
\frac{d \phi_{r}}{d \gamma_{t}^{\prime}}=2 a^{2}(\eta-1)-\eta
$$

我们可以在圆形模型中使用 $\eta^{*}=2 a^{2}(\eta-1)-\eta+2$来近似模拟偏心率的影响。

为了将这种方法应用于实际模型，我们只需要对 $\phi_{h}$值进行正弦插值来定义 $\eta^*$：

$$
\begin{aligned}\eta_{1}^{*} &=2(\eta-1) a^{2}-\eta+2 \\\eta_{2}^{*} &=2(\eta-1) a^{-2}-\eta+2 \\\eta^{*}\left(\phi_{h}\right) &=\frac{1}{2}\left(\left(\eta_{1}^{*}+\eta_{2}^{*}\right)+\cos \left(2 \phi_{h}\right)\left(\eta_{1}^{*}-\eta_{2}^{*}\right)\right)\end{aligned}
$$

1. 总结

我们已经推导出了M项和N项的函数，实际渲染时可以根据需要在式（6）添加常数项来模拟间接散射分量。

### 结果

![屏幕截图 2022-04-08 192532.png](%E6%AF%9B%E5%8F%91%E6%B8%B2%E6%9F%93%20b61a11035bac4e1c99f9e4041593ac34/%E5%B1%8F%E5%B9%95%E6%88%AA%E5%9B%BE_2022-04-08_192532.png)

图六：Kajiya-Kay模型（左），Marschner模型（中），实际照片（右）

## 参考资料

[Dual Scattering Approximation for Fast Multiple Scattering in Hair](https://dl.acm.org/doi/abs/10.1145/1399504.1360631)

[Light Scattering from Human Hair Fibers](http://graphics.stanford.edu/papers/hair/hair-sg03final.pdf)

• [角色渲染技术——毛发及其他](https://zhuanlan.zhihu.com/p/27313644)

[爱丽丝的发丝──《爱丽丝惊魂记：疯狂再临》制作点滴](https://www.cnblogs.com/miloyip/archive/2011/06/14/alice_madness_returns_hair.html)