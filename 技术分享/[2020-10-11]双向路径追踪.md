# 文档背景

这份文档是在双向路径追踪分享的基础上编写的，所以不会赘述分享上介绍的BDPT（Bidirectional Path Tracing）基本思想，也不是一份实现BDPT的教程。

本文旨在帮助读者对BDPT能够有一个更深刻的理解，也会提及一些实现的过程中需要注意到的地方，但不是全部的细节。

所以想要充分的利用好这份文档，你应该：

1. 理解并熟悉Path Tracing的核心思想
2. 了解BDPT的核心思想

我的目标是让你读完本文后，能够：

1. 对BDPT有更全面、深刻的认识
2. 在没有实现代码的情况下，尝试基于已有的Path Tracing代码去实现BDPT，哪怕道路崎岖过程曲折

如果上方建议的知识储备不够，本文能够有效地帮助你扩展知识面，也算是功德圆满。



参考资料写在前面，有兴趣的朋友可以通过第一手资料学习

- [Eric P. Lafortune, Yves D. Willems, BI-DIRECTIONAL PATH TRACING (1993)](https://www.cs.princeton.edu/courses/archive/fall03/cs526/papers/lafortune93.pdf)
- [Eric Veach, Leonidas Guibas, Bidirectional Estimators for Light Transfort (1995)](http://www0.cs.ucl.ac.uk/research/vr/Projects/VLF/vlfpapers/multi-pass_hybrid/Veach_E__Bi-directional_Estimators_for_Light_Transport.pdf)



# PathTracing核心思想概述

路径追踪，顾名思义，追踪某条路径。叫“追踪”是因为在光线追踪的框架下，我们从摄像机位置开始随着一个个交点走向深处，这些交点可能来源于摄像机模拟的视线与场景相交，也可能来源于光线在相交点弹射后与场景再度相交，直至击中光源或达到设置的递归深度而退出。这些交点，便组成了一条由摄像机连通光源的路径。

辐射能量便通过这条路径，由光源传递到了人眼，即摄像机。

连续的积分在计算机中只能以离散的形式被计算，为了解决一条光线击中场景后散发出来的多条射线引起的指数爆炸，只能计算一个方向的辐射能量，以某一分布多次采样计算来计算近似值，最简单的就是均匀分布，这是蒙特卡洛积分的思想。

而路径追踪就是用蒙特卡洛方法去解渲染方程。

# 从PT到BDPT

两者区别就是在生成这条通路时的策略不一样，核心的计算方法同样是蒙特卡洛。

在路径追踪之后，也有人做了Forward Path Tracing，即从光源开始采样，逐步走向摄像机。Backward Path Tracing就是传统的Path Traicng。而BDPT就是在生成这条路径时，从两端同时开始采样，然后将其连通，得到一条完整的通路。

在我看来，FPT、BPT和BDPT的区别是近乎本质的。

不论是FPT还是BPT，我们中学就知道，光路可逆。而FPT和BPT发出的射线都不一定能够顺利抵达另一端，在现实中，这不是问题，但是在计算机的实现过程中，递归是要有出口的。尽管理论上来说这些光线必能顺利抵达另一端，但是递归深度不允许，我们拥有的时间和空间资源（递归函数栈）不允许。所以就会有很多射线递归计算深度已达上限，但是还没有击中另一端，那么这条路径就会被舍弃，付出的时间和空间都被生生抹去。而BDPT已经是在两端点已达的基础上，来找到中间路径，尽管中途可能被物体阻挡，但这是正确的，现实即如此。

# 构造双向路径

要的就是这条路径，其他的都不重要。

1. 要有摄像机和光源两个端点的信息，同时开始追踪。摄像机一端的思路基本不变，第一个交点还是视线与场景的交点；光源一端则要先对光源采样获得起始的交点。之后，分别继续计算交点，后面的思路与路径追踪一直。不同的是，这里将PT的递归变为了循环，并且这一步中PT直接计算能量，而BDPT只保存交点，并为计算实质的能量辐射。
2. 每一个交点都要有自己的信息如位置、法线、材质等
3. 将前向路径和后向路径连接，这一步很简单，只要判断两条路径的末端交点之间是否有物体阻碍传播能量即可

由此，便得到了一条完整的路径，之后再计算这条路径上的能量传播情况即可。我认为实际上这种思路比递归要更容易理解。

# 计算

任何一个相交点的光照都分为直接和间接，直接光照很容易计算，间接光照需要按顺序计算，因为路径是有顺序的，以现实为例，光照传播是有方向性的，从光源向摄像机传播。

这是PT的思路，完全可以在BDPT中继续沿用。

Larfotune在BI-DIRECTIONAL PATH TRACING中提出了权重的概念，将间接光的计算分布到整条路径上，但是没有给出显示的算式，可以去论文里查阅。而Veach将渲染方程改写成了射线的形式，但核心思想还是不变的。

Tips: 

- 从摄像机发出的光线并不是全部都能够生成路径，有的射线初始就没有与场景相交。同理，对光源采样得到的方向也不一定有效。这两个起始端都需要判断是否具备构造一条通路的条件。
- 测试太慢可以先把程序改称多线程，在未来不知道还有多少次测试中节省的时间非常可观。

